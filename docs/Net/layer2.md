### 链路层概述

术语：

- 主机和路由器：概括性地称为结点（nodes）
- 连接相邻结点的通信信道：链路（links），包括有限链路、无线链路、局域网（LAN）
- 链路层（第2层）的数据分组：帧（frame），封装网络层的数据报

链路层负责通过一条链路从一个结点向另一个物理链路直接相连的相邻结点传送数据报。

注意：交换机不算是一个结点。

链路层提供的服务：

- 组帧：封装数据报构成数据帧，加首部和尾部。
- 链路接入：如果网络中是共享介质（很多结点都要用该链路传输），需要解决信道接入问题，防数据干扰。帧首部的MAC地址，用于标识帧的源和目的。MAC是链路层的地址，IP是网络层的地址。
- 相邻结点间的可靠交付：有线链路误码率低，很少采用；无线链路误码率高，需要可靠交付。
- 流量控制：协调相邻发送结点和接收结点。
- 差错检测：未必进行可靠传输，但是一般都有差错检测。信号衰减和噪声会引起差错，如果检测到差错，通知重传或丢弃。
- 差错纠正：接收端直接纠正比特差错。
- 全双工和半双工通信控制。

链路层的具体实现：一般在网卡中实现，链接主机的系统总线。

![网卡间通信示意图](http://book.moecode.com/net/layer2/1.png)



### 差错编码

基本原理：D->DR，R位差错检测与纠正比特（冗余比特），通过冗余比特建立位与位之间原本不存在的关联关系，接收方收到以后来检测关联关系是否存在。

冗余数据是根据一段/一组信息获得的：分组码；根据连续多组信息获得：卷积码。卷积码在通信领域应用多。计算机网络中常用分组码，其进一步分为线性分组码和非线性分组码，依据 R 的获得方法来划分。这里讲的编码都是线性分组码。

差错编码分为检错码和纠错码。

- 对于检错码，如果编码集的汉明距离为 r+1 ，则该差错编码可以检测 r 位差错。如图所示用图形表示编码和编码之间的距离，左右两个黑色的表示有效编码，由于编码集的汉明距离是 r+1 ，当一个编码从 Ci 发生 r 位错误变为 C' 时仍为无效编码，所以能够检查出错误。

  <img src="http://book.moecode.com/net/layer2/2.png" alt="检错码" style="zoom:50%;" />

- 对于纠错码，如果编码集的汉明距离为 2r+1 ，则该差错编码可以纠正 r 位的差错。如图所示两个有效编码之间的距离为 2r+1 ，当一个有效编码出错r位，它到两个有效编码的距离分别为 r 和 r+1 ，则它更有可能是从距离它 r 的编码发生错误得到的。可见差错纠正是基于概率最大化原则的。

  <img src="http://book.moecode.com/net/layer2/3.png" alt="纠错码" style="zoom:50%;" />

奇偶校验：1比特奇偶校验，二维奇偶校验。

Internet校验和：回顾流程如图所示。

![校验和计算流程](http://book.moecode.com/net/layer2/4.png)

循环冗余校验吗：检错能力十分强大，依据的是多项式理论。详见计组课程。



### 多路访问控制协议

链路的分类：

- 点对点链路：拨号接入、以太网交换机与主机之间的点对点链路
- 广播链路（共享介质）：局域网中多见。如果使用广播链路，必须有机制来控制谁来使用介质等。

如果有两个或两个以上的结点同时进行传输，就会产生干扰，称为“冲突”。实际上就导致结点同时接收到两个或者多个信号，表明接收失败。所以需要多路访问控制协议（Multiple Access Control Protocol，MAC协议）。基本原则：

- 采用分布式算法来决定结点如何共享信道，不使用特殊的结点进行集中协调。

- 必须基于信道本身进行协调，没有带外信道用于协调。

理想的MAC协议的期望如下图所示：

![理想MAC协议的期望](http://book.moecode.com/net/layer2/5.png)

MAC协议的分类：

- 信道划分MAC协议：采用多路复用技术，由于资源已经被划分，所以一定不会发生冲突。
- 随机访问MAC协议：局域网中多见，信道不划分且允许冲突，采用冲突“恢复”机制。
- 轮转MAC协议：结点轮流使用信道。

信道划分MAC协议：好处是不冲突，缺点是当网络负载轻的时候信道利用率不高。

- TDMA：time division multiple access. 周期性地接入信道，会有空闲的时隙。
- FDMA：频分复用，分成若干频带，也会有空闲的频带。



### 随机访问MAC协议：ALOHA协议

当结点要发送分组时，利用信道的全部数据速率R来发送分组，没有事先的结点间协调，所以可能发生冲突。该协议需要定义两方面的内容：如何检测冲突，如何从冲突中恢复。典型的随机访问协议：（时隙）ALOHA、（纯）ALOHA、CSMA、CSMA/CD、CSMA/CA。

时隙ALOHA协议：假定网络中所有帧的大小相同；将时间划分为登场的时隙，每个时隙可以传输一个数据帧；结点只能在时隙开始的时刻发送帧，因此需要进行结点间的时钟同步；如果2个或2个以上的结点在同一时隙发送帧，结点就会检测到中途。

该协议如何运行？对于每一个结点，当结点有新的帧时，在下一个时隙发送。如果没冲突则该结点可以在下一个时隙继续发送新的帧；如果发生冲突，则该结点在下一个时隙以概率 p 重传该帧，直到发送成功。为什么不直接重传呢？这样会一直冲突下去。

时隙ALOHA的优点：单个结点活动时，可以连续以信道全部速率传输数据；协议高度分散化，但需要同步时钟；简单。

缺点：容易发生冲突，浪费时隙；容易出现空闲的时隙，也浪费；需要时钟同步，成本高。

计算时隙ALOHA协议的效率如下图所示。网络忙碌时效率只有37%。

![时隙ALOHA的效率](http://book.moecode.com/net/layer2/6.png)

纯ALOHA协议则更为简单，不需要时钟同步，但是更容易发生冲突，因为在一个帧发送的期间一旦有别的帧在发送就会导致冲突。经过计算得知其效率变为时隙ALOHA的一半。

![纯ALOHA的效率](http://book.moecode.com/net/layer2/7.png)

### 随机访问MAC协议：CSMA协议

ALOHA协议实际上是个“自私”的协议，因为当别的帧在发送的时候自己也发送（损人不利己）。为了改进这一缺点，可以加入监听机制，在发送帧之前监听信道中是否有数据帧在进行传输。

载波监听多路访问协议CSMA（carrier sense multiple access）：就是在发送帧之前对信道进行监听，如果信道是空闲的，那么就发送完整的帧；如果信道是忙碌的，那么就推迟发送。根据推迟发送策略的不同，CSMA可做如下分类：

- 1-坚持CSMA：监听到忙碌时，以概率1继续监听，一旦信道空闲就发送数据帧。
- 非坚持CSMA：监听到忙碌时，随机过一段时间再回来监听。
- P-坚持CSMA：监听到忙碌时，以概率P继续监听，以概率 1-P 随机等待一段时间再回来听。

事实上就算有了监听仍然可能发生冲突：

- 坚持监听的主机可能在信道空闲下来时同时发送数据帧，导致冲突。
- 信号传播延迟，自己以为是空闲的，但实际上已经有数据在信道中了，只是还没到而已。

如图所示BD两台主机在不同的时刻发送数据帧（B发出后，D仍认为信道是空闲的）。普通的CSMA在D接收到B的数据后仍然传输还没有传输完的数据，尽管已经可以断定发生冲突了，对于B也是这样。这种情况会造成资源的很大浪费。

<img src="http://book.moecode.com/net/layer2/8.png" alt="CSMA示意图" style="zoom:50%;" />

为了克服这种缺点，我们希望D在接收到B的信号时立马停止自己数据的发送，对B也希望如此。这时候的改进版CSMA叫做CSMA/CD（CSMA with Collision Detection，带冲突检测的CSMA）。在这种协议下，短时间内就能够检测到冲突，这段时间称为collision detect/abort time，如图所示。CSMA/CD减少了信道的浪费。

<img src="http://book.moecode.com/net/layer2/9.png" alt="CSMA/CD示意图" style="zoom:50%;" />

要注意的是并不是只有CSMA/CD才有冲突检测机制，这里的CD是强调CSMA/CD能够短时间检测到冲突并作出响应的反应。任何随机访问协议都有冲突检测机制（这是随机访问协议的必要的定义），只不过他们可能是利用ACK等机制进行反馈，无法解决上面提到的资源浪费的问题。

另外，冲突检测机制在有线局域网中易于实现，只需检测信号的强弱，当接收信号大于发射信号的时候就知道有别的信号过来了。比如说自己发出的信号强度是5V，检测到的实际是8V，就可以知道有3V是别人的信号了。但对于无线局域网来说这种检测是难以实现的，因为信号在无线情况下衰减很快，其会被发射信号淹没，根本无法检测。

CSMA/CD还有一个特性就是“边发边听，不发不听”。我们可能会想，如果数据发送完了之后对方的数据帧才到这里，岂不是无法检测到冲突（进而不能进行冲突的恢复）？为了解决这个问题，我们只需让数据帧发送的时间足够长，以至于整个信道的主机都知道我在发送数据帧（他们就不会进行发送），而且就算有主机不小心赶在收到我的信号之前发送了数据，时间也足够长来保证我能收到他发送的数据从而得知已经发生了冲突。这个时间长度的具体计算如下图所示：

![数据帧最小长度的计算](http://book.moecode.com/net/layer2/10.png)

计算时考虑的是极限情况，也就是A发送的数据帧马上就要到达B了，B就发送了数据帧，这样一来A需要一个RTT来回才能知道已经发生了冲突，因而数据帧最小长度也需要满足图中所示的关系。

一道例题如下图所示：

![例题](http://book.moecode.com/net/layer2/11.png)

CSMA/CD效率的计算如下图所示，可见要比ALOHA好得多。

![CSMA/CD的效率](http://book.moecode.com/net/layer2/12.png)

CSMA/CD应用于以太网，CSMA/CA应用于802.11无线局域网（后面再讲）。



### 轮转访问MAC协议

- 信道划分MAC协议：网络负载重时，共享信道效率高，且公平；网络负载轻时，共享信道效率低！

- 随机访问MAC协议：网络负载轻时共享信道效率高，单个结点可以利用信道的全部带宽；网络负载重时，产生冲突开销。

- 轮转访问MAC协议：综合二者优点。

轮询：主结点轮流“邀请”从属结点发送数据。存在的问题：轮询的开销，等待的延迟（还没轮到自己），单点故障（因为有主结点）。

令牌传递：网络中只有一个令牌，令牌代表共享介质的使用权，其从一个结点传递到下一个结点。令牌就是特殊的数据帧。由于令牌网络的传递特征，其总是呈环形。存在问题：令牌的开销，也有等待延迟（还没到自己），也可能存在单点故障（某个主机导致令牌丢失）。事实上常有一个主结点来检测令牌是否还在网络中。

蓝牙用的是轮转协议。



### MAC地址

又称LAN地址，物理地址（但不是物理层的，是链路层的），以太网地址。

作用：用于局域网内标识一个数据帧从哪个接口发出，到达哪个物理相连的其他接口。

现在最常用的是48位MAC地址（大部分用于LANs），固化在网卡的ROM中，有时也可以软件设置。

比如：1A-2F-BB-76-09-AD

局域网中的每块网卡都有一个唯一的MAC地址。地址由IEEE统一管理和分配。网卡生产商购买MAC地址空间。做一个类比：MAC地址相当于身份证号，终身不变且唯一；IP地址类似于邮政地址，有层次关系，是不可“携带”的。

### ARP协议

ARP是地址解析协议。在同一个局域网中，如何在已知目的接口的IP地址前提下确定其MAC地址呢？

对于局域网中的每一个主机或路由器都要维护一个ARP表，用来存储某些LAN结点的IP/MAC地址映射关系。比如<IP; MAC; TTL>，经过TTL时间后该映射关系就会被遗弃（比如20min），因为网卡可以换或者其他原因会导致这种映射关系不是固定不变的。

考虑这样的情况：A希望向B发送数据，A知道B的IP地址但是其ARP表中没有B的MAC地址。如果A和B在同一个局域网中，那么ARP协议的工作状况如下图所示：

![同一个局域网中ARP工作流程](http://book.moecode.com/net/layer2/13.png)

如果A和B不在同一个局域网中，A该如何才能将数据帧传输给B呢？考虑下面例子中的通信过程。回答图中的三个问题：

1. 可能用户在A中输入了B对应的域名，解析得到B的IP地址；
2. R是A所在的局域网的默认网关；
3. A通过ARP协议在同一个局域网内获得R的MAC地址。

![寻址举例](http://book.moecode.com/net/layer2/14.png)

具体地来说，将数据帧从A发送到B两次通过ARP协议找到了目的MAC地址，注意这里的两段路径数据帧的目的MAC地址不同，但是目的IP地址一般是相同的。为什么说是一般呢？如果子网实现了NAT，那么IP数据报的源IP或目的IP可能会发生改变。

![寻址过程1](http://book.moecode.com/net/layer2/15.png)

![寻址过程2](http://book.moecode.com/net/layer2/16.png)

![寻址过程3](http://book.moecode.com/net/layer2/17.png)



### 以太网

以太网是居于统治地位的有线局域网技术，造价低廉且应用最广泛，比令牌局域网和ATM等要更简单和便宜，还能一直满足网络速率的需求。

总线结构在上世纪90年代中期之前流行，所有的结点都连到同一条总线，所有的结点都在同一个冲突域。所谓冲突域就是如果两个主机同时发送数据就会发生冲突的这样一个网络范围。以太网使用的就是CSMA/CD，可以说CSMA/CD监听的范围就是一个冲突域。这样的以太网叫做共享式以太网/广播以太网。

现在的以太网比较流行的网络拓扑结构是星型结构，中间是交换机。这样的以太网叫做交换式以太网。如果中间是集线器（物理层设备），那么其逻辑上还是广播式以太网。交换式以太网不存在传统意义上的“冲突”，因为这样的点对点链路中的冲突域中只有一台计算机。

以太网提供的是不可靠的、无连接的服务。

- 无连接：发送帧的网卡与接收帧的网卡间没有“握手”过程。
- 不可靠：接收网卡不向发送网卡进行确认。

事实上以太网用于局域网范围内，所以数据的误码率很低。差错帧直接丢弃，丢弃帧中的数据恢复依赖于高层的协议比如TCP。

以太网的MAC协议：采用二进制指数退避算法的CSMA/CD。该算法用于决定当发生冲突的时候随机等待多长一段时间在进行数据帧的传输。具体的工作流程如下图所示：

![以太网的CSMA/CD算法](http://book.moecode.com/net/layer2/18.png)

由流程可见，连续冲突次数越多，平均等待时间则越长，因为冲突次数表明网络的忙碌程度。

实际上协议不会让冲突一直连续发生下去，当连续发生了 `16` 次冲突后以太网就会像上层报告错误。

以太网的帧结构：

- 前导码（8字节）：前七个字节是10101010，第八个字节是10101011。用于发送端和接收端的时钟同步。不说明时不算入以太网帧的总长度。
- 目的MAC地址、源MAC地址（各6个字节）：全1是广播。
- 类型（2字节）
- 数据（46-1500字节）：1500字节定义了以太网的MTU，如果不够46字节就要进行填充。有最小长度是为了实现前面提到的“边发边听，不发不听”。
- 循环冗余编码（4字节）

![以太网帧结构](http://book.moecode.com/net/layer2/19.png)

有很多不同的以太网标准，他们的MAC协议和数据帧的格式是相同的，不同的是传输的速率和依靠的物理介质。



### 以太网交换机

以太网交换机是链路层设备，可以实现以太网帧的存储和转发，还可以检验到达帧的目的MAC地址，选择性地向一个或多个输出链路来转发帧。应用的是CSMA/CD协议。

- 主机感知不到交换机的存在，对主机来说是透明的。
- 交换机不需要进行配置，其自动进行学习。
- 主机利用独享的链路直接连接交换机，因而不会有冲突。
- 交换机会对帧进行缓存。
- 交换机在每段链路上利用CSMA/CD发送接收帧，没有冲突且可以全双工。
- 不同对主机的信息传输可以无冲突同时进行，称为交换。

每个交换机维护一个交换表，存放类似于这样的表项：（主机的MAC地址，到达主机的接口，时间戳）。那交换表的入口信息（表项）是如何创建和维护的呢？

交换机通过自学习获知到达主机的接口信息。当交换机接收到数据帧时，交换机就学习到：发送帧的主机（通过帧的源MAC地址学习到）位于收到该帧的接口所连接的LAN网段。随后就将发送主机MAC地址以及对应的接口信息记录到交换表中。

数据帧的学习和转发过程也叫做帧过滤/转发，具体过程如下图所示：

![帧过滤/转发](http://book.moecode.com/net/layer2/20.png)

中间的“丢弃帧”是因为目的主机和源主机位于同一个网段，交换机认为不需要通过交换机进行转发。

多个交换机互联时，自学习过程和单个交换机的情形时类似的。

交换机和路由器的比较：

- 它们都是存储转发设备。
- 路由器是网络层设备（检测网络层分组首部）。
- 交换机是链路层设备（检测链路层帧的首部）。
- 二者均使用转发表。
- 路由器利用路由算法（协议）计算，依据的是IP地址。
- 交换机利用自学习、泛洪来构建转发表，依据的是MAC地址。

网络设备对比如下图所示：

![网络设备对比](http://book.moecode.com/net/layer2/21.png)

直通传输指的是收到的同时能够立刻转发出去。链路层设备不能够隔离广播域，也就是说由多个交换机连在一起的主机都处于同一个广播域中，但是能够隔离冲突域。

### 虚拟局域网VLAN

VLAN的动机：希望在大的广播域中进一步进行广播域的隔离，且又不希望引入路由器。

如图所示支持VLAN的交换机可以配置多个VLAN。

![VLANs](http://book.moecode.com/net/layer2/22.png)

VLAN可以实现流量隔离，基于软件来划分VLAN，所以其灵活性很强！VLAN之间的转发可以通过路由器实现。

![基于端口的VLAN](http://book.moecode.com/net/layer2/23.png)

如果同一个VLAN分别在多个交换机中（跨越多交换机的VLAN），如何将它们连接在一起呢？一种方法是用多线缆连接，比如下图所示可以1号连2号，就能将两个交换机中的蓝色VLAN连在一起。但是这种方法会浪费端口，改进的方法是采用`中继端口`。各VLAN都通过这个中继端口发送信息，这样也就要求数据帧必须带上VLAN的ID，不然分不清发送过来的数据是哪个VLAN的。

![跨越多交换机的VLAN](http://book.moecode.com/net/layer2/24.png)

为了解决这个问题，对802.1以太网提出了扩展版802.1Q，在中间插入了4个字节的信息进行标记。

![VLAN帧格式](http://book.moecode.com/net/layer2/25.png)
