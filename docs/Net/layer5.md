### 网络应用的体系结构

客户机/服务器结构（Client-Server, C/S）：服务器需要7*24小时提供服务，有永久性访问地址/域名，利用大量服务器实现可扩展性；客户机与服务器进行通信，间歇性接入网络，可能使用动态的IP地址，不会与其他客户机直接通信。比如Web服务就是典型的C/S结构。

点对点结构（Peer-to-peer, P2P）：没有永远在线的服务器，任意端系统/节点之间可以直接通信，节点间歇性接入网络，节点可能改变IP地址。比如文件共享就是P2P结构。最大优点是高度可伸缩，缺点是难于管理。

混合结构（Hybrid）：比如Napster，文件传输使用P2P结构，文件搜索采用集中式的C/S结构。每个节点向中央服务器登记自己的内容，每个节点向中央服务器提交查询请求，查找感兴趣的内容。



### 网络应用进程通信

进程是主机上运行的程序。同一主机上运行的进程之间有操作系统提供的进程间通信机制。不同主机上的进程通信需要消息交换，有客户机进程和服务器进程，分别是发起通信和等待通信请求的进程。P2P架构的应用中也要有客户机/服务器进程。

消息交换需要使用套接字Socket进行消息的发送和接收。传输基础设施向进程提供API，API可以选择传输协议和设定参数。

消息发出去之后如何进行进程的寻址呢？不同主机上的进程间通信，那么每个进程必须拥有标识符。首先要寻址主机，用的是IP地址；此外还需要端口号来区分主机上的不同进程。操作系统为主机上每个需要通信的进程分配一个端口号，有些端口号是已经被占用，比如HTTP Server是80端口，Mail Server是25端口。总结：进程的标识符是IP地址+端口号。

具体的消息交换怎么做呢？这需要应用层协议。应用层协议有公开的协议，由RFC（Request For Comments）定义，这是为了允许互相操作。公开协议比如由HTTP、SMTP等。IETF维护RFC文档。

私有协议比如多数的P2P文件共享应用，出于商业目的。

应用层协议的内容：

- 消息类型：请求消息、响应消息。
- 消息的语法格式：消息中有哪些字段、每个字段如何描述。
- 字段的语义：字段中信息的含义。
- 规则：进程何时发送/响应消息、如何发送/响应消息。



### 网络应用需求与传输层服务

- 数据丢失/可靠性方面的需求：有些应用能够容忍一定的数据丢失，有些应用要求100%可靠的数据传输。
- 时间/延迟的需求：有些应用需要延迟足够低才有效。
- 带宽要求：某些应用只有在带宽达到最低要求才有效比如网络视频，有些能够适应任何带宽，叫弹性应用，比如email。

典型网络应用对传输服务的需求如下图所示：

![典型应用的需求](http://book.moecode.com/layer5/1.png)

Internet提供的传输服务：

- TCP服务：面向连接、可靠、流量控制、拥塞控制、不提供时间/延迟保障、不提供最小带宽保障。
- UDP服务：无连接、不可靠数据传输、不提供可靠性/流量/拥塞/延迟/带宽。

典型的网络应用所使用的应用层协议如下图所示：

![典型应用的协议](http://book.moecode.com/layer5/2.png)



### Web与HTTP

Web应用起源于1990年，使得Internet从众多网络中脱颖而出，称为当今世界上事实上唯一的网络。

基本的构成要素：网页、网页之间的相互链接。网页包含多个对象比如HTML文件、图片、视频、动态脚本等，每个网页有一个基本的HTML文件。对象如何寻址呢？使用URL（Uniform Resource Locator，统一资源标识符）来标识，格式如下：

<center>Scheme://host:port/path</center>
HTTP协议概述：HyperText Transfer Protocol，超文本传输协议。使用C/S架构，客户是Browser浏览器，用于请求、接受、展示Web对象；服务器是Web Server，用于响应客户的请求，返回对象，比如Apache软件，是当前的事实标准。

HTTP有1.0和1.1版本。

使用TCP传输服务，如下图所示。

![TCP服务与无状态](http://book.moecode.com/layer5/3.png)



### HTTP连接

两种不同类型：

- 非持久性连接（Nonpersistent HTTP）：每个TCP连接最多允许传输一个对象，HTTP1.0版本使用非持久连接。
- 持久性连接（Persistent HTTP）：每个TCP连接允许传输多个对象，HTTP1.1版本默认使用持久性连接。

![非持久性连接1](http://book.moecode.com/layer5/4.png)

![非持久性连接2](http://book.moecode.com/layer5/5.png)

非持久性连接如上图所示，可见非持久性连接的速度比较慢。响应时间分析建模如下图所示。

![时间分析](http://book.moecode.com/layer5/6.png)

非持久性连接的问题：每个对象需要2个RTT，消耗时间很大；操作系统需要为每个TCP连接开销资源（非持久性连接的话TCP连接的个数很多）；浏览器可能会打开多个并行的TCP连接以获取网页所需的对象，但这给服务端造成巨大的压力。

可以使用持久性连接：发送响应后服务器保持TCP连接的打开，后续的HTTP消息可以通过这个连接发送。

- 无流水的持久性连接：客户端只有收到前一个响应后才发送新的请求，每个被引用的对象耗时1个RTT。
- 带流水机制的持久性连接：HTTP1.1的默认选项，客户端只要遇到一个引用对象就尽快发出请求，理想情况下，收到所有的引用对象只需耗时约1个RTT（如果传输文件的时间相对于RTT来说可以忽略的话）。



### HTTP消息格式

HTTP协议有两类消息：请求消息（request）和响应消息（response）。

请求消息是ASCII消息，可以直接阅读。第一行是请求行包括请求方法、PATH、HTTP版本。下面是头部行，头部行可以有Host，那为什么需要host呢，明明连接都已经建立了？事实上host信息可以用于缓存和代理服务器，如果不使用这两个功能可以不用host。头部行还有User-agent（浏览器）和语言，可以用于服务器选择不同版本的网页发送过去。头部行下面是空行，再下面是数据（比如输入的表格信息）。

![HTTP请求报文](http://book.moecode.com/layer5/7.png)

上传输入的方法有两种：POST方法（信息放在消息体中），使用GET的URL方法（在URL中添加参数）。

方法类型如下图所示：

![方法类型](http://book.moecode.com/layer5/8.png)

HTTP响应消息如下图所示。第一行是状态行，下面是头部行，头部行中Date是Web服务器生成响应消息的时间，而Last-Modified是上一次修改的时间。再下面是空行，后面是数据。

![响应消息举例](http://book.moecode.com/layer5/9.png)

状态行：

- 200 OK
- 301 Moved Permanently
- 400 Bad Request
- 404 Not Found
- 505 HTTP Version Not Supported

可以使用telnet应用体验HTTP请求响应的过程。

![telnet举例](http://book.moecode.com/layer5/10.png)



### Cookie技术

HTTP是无状态的，会带来一些问题。很多应用需要服务器掌握客户端的状态，比如网上购物。如何实现？

Cookie技术是某些网站为了辨别用户身份、进行session跟踪和存储在用户本地终端上的数据，通常经过加密。

Cookie的组件：

- HTTP响应和请求消息的cookie头部行（HTTP消息是可扩展的）。
- 保存在客户端主机上的cookie文件，由浏览器管理。
- Web服务器端的后台数据库。

![cookie示例](http://book.moecode.com/layer5/11.png)

Cookie可以用于：

- 身份认证（自动登录）
- 购物车
- 推荐
- Web email

但是存在隐私问题。



### Web缓存/代理服务器技术

功能：在不访问服务器的前提下满足客户端的HTTP请求。

为什么要发明这种技术？

- 缩短客户请求的响应时间
- 减少机构/组织的流量
- 在大范围内实现有效的内容分发

在客户和服务器之间架设了代理服务器。用户设定浏览器通过缓存进行Web访问，浏览器向缓存/代理服务器发送所有的HTTP请求。

- 如果所请求对象在缓存中，缓存就返回对象。
- 否则，缓存服务器向原始服务器发送HTTP请求，获取对象，然后返回给客户端并保存该对象。

缓存既充当客户端，也充当服务器。一般有ISP（Internet服务提供商）架设。

![示意图](http://book.moecode.com/layer5/12.png)

具体内容参见MOOC，课内似乎并不要求。



### Email应用

Email应用的构成：

- 邮件客户端（user agent）：负责读写Email消息，与服务器进行交互，收/发Email信息。
- 邮件服务器（mail server）：应用的核心，为每个用户配置邮箱，存储发给该用户的Email。创建消息队列，存放要发出的消息，确保将邮件发到指定的地方。
- SMTP协议（Simple Mail Transfer Protocol）：有客户端和服务器。采用服务器的好处？我们的客户端没法保证一直在线，服务器可以确保服务的进行。

SMTP协议依赖于TCP协议，端口25，传输过程的三个阶段：握手、消息的传输、关闭。采用命令/响应交互模式（注意HTTP采用请求/响应模式）。命令是ASCII文本，响应是状态代码和语句。Email消息只能包含7位ASCII码，因为邮件是很古老的应用。那现在为什么能支持多媒体呢？

Email是典型的异步应用。示例如下图所示：

![Email示例](http://book.moecode.com/layer5/13.png)

SMTP交互示例如下图。

![SMTP示例](http://book.moecode.com/layer5/14.png)

SMTP协议特点：

- 使用持久性连接。
- 要求消息必须由7位ASCII码构成。
- SMTP服务器利用CRLF.CRLF（\r\n.\r\n，也就是回车换行+‘.’+回车换行）确定消息的结束。

与HTTP对比：

- HTTP是拉式（pull）而SMTP是推式（push），后者是由发送方主动与接收方建立连接，把消息主动推送给接收方。
- 都使用命令/响应交互模式。
- 命令和状态代码都是ASCII码。
- HTTP每个对象封装在独立的响应消息中，而SMTP多个对象由多个部分构成的消息中发送。



### Email消息格式和POP协议

Email消息格式如下二图所示。MIME行是为了实现多媒体的传输而扩展的。

![Email消息格式1](http://book.moecode.com/layer5/15.png)

![Email消息格式2](http://book.moecode.com/layer5/16.png)

邮件访问协议。收件人从服务器获取邮件时不能使用SMTP协议，因为SMTP是推式的。我们使用邮件访问协议来实现从服务器获取邮件的功能。可见一个应用可以由不同的应用层协议来支持。

![邮件访问示意图](http://book.moecode.com/layer5/17.png)

典型的邮件访问协议

- POP（Post Office Protocol），有两个阶段：认证/授权（服务器对客户端进行认证）和下载。

- IMAP（Internet Mail Access Protocol）：比POP更新，更多功能，实现起来更复杂，能够操纵服务器上存储的消息。
- HTTP：163、QQ Mail等。基于Web的Email使用HTTP。

**POP3协议**：

- 认证阶段。客户端命令：User声明用户名，Pass声明密码。服务器响应：+OK表示合法，-ERR表示非法。
- 事务阶段。List列出消息数量，Retr用编号获取消息，Dele删除消息，Quit表示推出。

POP3示例如下图所示，有认证阶段和事务阶段。

![POP3示例](http://book.moecode.com/layer5/18.png)

POP3有几种模式：

- “下载并删除”模式：如果用户换了客户端就无法重读邮件。
- “下载并保持”模式：不同客户端都可以保留消息的拷贝。这样服务器的压力比较大，现在随着技术的发展问题不大。

POP3是无状态的。

**IMAP协议**：

- 所有消息统一保存在一个地方：服务器。
- 允许用户利用文件夹组织消息。
- IMAP支持跨会话的用户状态，即所有的客户端的状态都是一样的。比如文件夹的名字、文件夹与消息ID之间的映射等。这里可见IMAP是个有状态的协议。



### DNS概述

Domain Name System，域名系统。解决Internet上主机/路由器的识别问题。每台主机/路由器都有IP地址，IP是数字不利于人使用，人使用的是更便于记忆的域名。两者之间的映射问题由域名解析系统DNS解决。

为什么DNS复杂？因为规模大，不能集中式服务，需要多层命名服务器构成的分布式数据库。DNS也是应用层协议，用于完成名字的解析。DNS是互联网的核心服务，但是又在应用层来实现（注意这里的“核心”相对于“边缘”）。

DNS服务：

- 域名向IP地址的翻译
- 主机/邮件服务器别名
- 负载均衡：Web服务器。翻译时提供多个映射即可，轮流服务。

为什么不使用集中式的DNS？

- 单点失败问题
- 流量问题
- 距离问题
- 维护性问题

分布式层次式数据库示意图。

![示意图](http://book.moecode.com/layer5/19.png)

当本地域名服务器无法解析域名时，访问根域名服务器。根域名服务器如果不知道映射就访问权威域名服务器获得映射，并向本地域名服务器返回映射。全球有13个根域名服务器。

顶级域名服务器（TLD，top-level domain）：负责com/org/net/edu等顶级域名和国家顶级域名如cn/uk/fr等。比如Network Solutions维护com顶级域名服务器，Educause维护edu顶级域名服务器。

权威域名服务器：组织的域名解析服务器，提供组织内部服务器的解析服务。组织或服务提供商负责维护。

本地域名解析服务器：不严格属于层级体系。每个ISP有一个本地域名服务器，也叫做“默认域名解析服务器”。当主机进行DNS查询时，查询被发送到本地域名服务器，作为代理（proxy）将查询转发给（层级式）域名解析服务器系统。

DNS查询有两种，一种是迭代查询，一种是递归查询，分别如下两张图所示。可见递归查询对根服务器的压力很大。

![DNS迭代查询示例](http://book.moecode.com/layer5/20.png)

![DNS递归查询示例](http://book.moecode.com/layer5/21.png)

例题：

![例题](http://book.moecode.com/layer5/22.png)

DNS记录缓存和更新的问题。只要域名解析服务器获得域名-IP映射，就要缓存这一映射。一段时间过后缓存条目会失效（被删除，为了缓存最新的）。本地域名服务器一般会缓存顶级域名服务器的映射，因此**根域名服务器不经常被访问**。

DNS还有记录的更新和通知机制，不详述。



### DNS记录和消息

DNS记录又称为资源记录（RR，resource records），格式：（name, value, type, ttl）。

- Type=A：Name-主机域名，Value-IP地址
- Type=NS：Name-域（edu.cn），Value-该域权威域名解析服务器的主机域名
- Type=CNAME：Name-某一真实域名的别名，Value-真实域名
- Type=MX：Value-与name相对应的邮件服务器

DNS协议和消息格式。DNS协议是一个查询和回复协议（回忆：HTTP请求响应，SMTP命令响应），查询和回复的格式是一样的，如下图所示。

![DNS消息](http://book.moecode.com/layer5/23.png)

注册域名的流程如下图所示。

![域名注册](http://book.moecode.com/layer5/24.png)



### P2P应用：原理与文件分发

Peer-to-peer：没有服务器、任意端系统之间直接通信、节点阶段性接入Internet、节点可能更换IP地址。缺点是实现起来比较复杂。C/S架构和P2P架构进行文件分发的计算如下图所示。

![](http://book.moecode.com/layer5/25.png)

![](http://book.moecode.com/layer5/26.png)

![](http://book.moecode.com/layer5/27.png)



**BitTorrent、视频流及内容分发网路参考课本与课内课件。**